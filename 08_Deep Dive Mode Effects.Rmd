---
title: "Deep dive mode effects"
author: "Julia Rohrer"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("prep.RData")
library(haven)
library(marginaleffects)
library(ggplot2)
library(gridExtra)
library(dplyr)
library(patchwork)


combined$source <- as.factor(combined$source)
combined$age <- as.factor(combined$age)
```

We are going to dive deeper into the mode effects, testing various things that were brought up during a colloquium presentation of the findings.

## What about mode effects on the other items?
We will use the model specification with controls to check for mode effects on the other satisfaction items.
Maybe the mode effects only show up for items that are perceived as somewhat sensitive -- where students may have been reluctant to give honest answers on paper.


```{r mode_satis_controlled}
# satis, for comparison
mode_effects_controlled <- lm(satis ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))
# satis_money
# matches the pattern
mode_effects_controlled_money <- lm(satis_money ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_money, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_money, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_money, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

# satis_friends
mode_effects_controlled_friends <- lm(satis_friends ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_friends, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_friends, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_friends, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

# satis_mom
mode_effects_controlled_mom <- lm(satis_mom ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_mom, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_mom, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_mom, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))


# satis_dad
mode_effects_controlled_dad <- lm(satis_dad ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_dad, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_dad, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_dad, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

# satis_leisure
# Boys happier with their leisure time activities when responding on tablet
mode_effects_controlled_leisure <- lm(satis_leisure ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_leisure, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_leisure, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_leisure, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

# satis_dwell
mode_effects_controlled_dwell <- lm(satis_dwell ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_dwell, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_dwell, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_dwell, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

# satis_grades
# cross over interaction
mode_effects_controlled_grades <- lm(satis_grades ~ source*gender +
                                age + age:gender + age:source +
                                as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                                as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
print(avg_predictions(mode_effects_controlled_grades, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_grades, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(mode_effects_controlled_grades, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

```

## Can the mode effect be explained by differential media usage -- gaming versus social media?
First, we will check differences in self-reported media usage -- between the genders, but also looking at source.
Keeping in mind that source "effects" can reflect either selection effects, or actual effects of the survey mode.

```{r media_usage}
media_usage_gaming <- lm(gaming ~ source*gender +
                    age + age:gender + age:source +
                    as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                    as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
summary(media_usage_gaming)
print(avg_predictions(media_usage_gaming, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_gaming, variables = "gender",  vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_gaming, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_gaming, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

media_usage_streaming <- lm(streaming ~ source*gender +
                    age + age:gender + age:source +
                    as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                    as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
summary(media_usage_streaming)
print(avg_predictions(media_usage_streaming, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_streaming, variables = "gender",  vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_streaming, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_streaming, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))

media_usage_socialmedia <- lm(socialmedia ~ source*gender +
                    age + age:gender + age:source +
                    as.factor(schooltype) + as.factor(schooltype):gender + as.factor(schooltype):source +
                    as.factor(mig_lang) + as.factor(mig_lang):gender + as.factor(mig_lang):source, data = combined[combined$year == 2023,])
summary(media_usage_socialmedia)
print(avg_predictions(media_usage_socialmedia, variables = c("gender", "source"), vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_socialmedia, variables = "gender",  vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_socialmedia, variables = "source", by = "gender", vcov = ~ unique_classroom))
print(avg_comparisons(media_usage_socialmedia, variables = "source", by = "gender", vcov = ~ unique_classroom,
                hypothesis = "b1 = b2"))


# Plot over age
comp_gaming <- avg_predictions(media_usage_gaming, by = c("gender", "age"), vcov = ~ unique_classroom)
ggplot(data = comp_gaming, aes(y = estimate, x = age, group = gender, color = gender)) +
  geom_point() +
  geom_line() +
  theme_classic()

comp_socialmedia <- avg_predictions(media_usage_socialmedia, by = c("gender", "age"), vcov = ~ unique_classroom)
ggplot(data = comp_socialmedia, aes(y = estimate, x = age, group = gender, color = gender)) +
  geom_point() +
  geom_line() +
  theme_classic()

comp_streaming <- avg_predictions(media_usage_streaming, by = c("gender", "age"), vcov = ~ unique_classroom)
ggplot(data = comp_streaming, aes(y = estimate, x = age, group = gender, color = gender)) +
  geom_point() +
  geom_line() +
  theme_classic()
```

I'm not sure what's the best way here to check whether gender differences in media usage can explain away the effects of survey mode.
I guess if we look at girls who report as much gaming as boys, we should not observe that the survey mode affects them.
This analysis seems problematic though if we assume that survey mode actually affects reported media usage!
So maybe let's keep that open for now and look at modification by age instead.

```{r media_usage_explain_away}
```


## Is the mode effect age specific which could point toward issues of familiarity?
```{r media_usage_age_moderation}
print(avg_predictions(mode_effects_controlled, variables = c("gender", "source", "age"), vcov = ~ unique_classroom))

predictions_mode_age <- avg_predictions(mode_effects_controlled, variables = c("gender", "source", "age"), vcov = ~ unique_classroom)

print(avg_comparisons(mode_effects_controlled, variables = "gender", by = c("source", "age"), vcov = ~ unique_classroom))
# Gender gap seems to narrow monotonically in both genders

print(avg_comparisons(mode_effects_controlled, variables = "source", by = c("gender", "age"), vcov = ~ unique_classroom))
predictions_mode_effects_age <- avg_comparisons(mode_effects_controlled, variables = "source", by = c("gender", "age"), vcov = ~ unique_classroom)

# Survey mode effect gets smaller for girls with increasing age

ggplot(data = predictions_mode_age, aes(y = estimate, x = age, group = interaction(gender, source), linetype = source, color = gender)) +
  geom_point() +
  geom_line() +
  theme_classic()

ggplot(data = predictions_mode_effects_age, aes(y = estimate, x = age, group = gender, color = gender)) +
  geom_point() +
  geom_line() +
  theme_classic()



```

